name: Docker Image CICD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Building image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
        
        
      - name: DockerHub login
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Create Google Cloud credentials file
        run: |
          echo "{
  "type": "service_account",
  "project_id": "prn-project-75959",
  "private_key_id": "0b38b36a7b9612d9e5bfd12dd88f4d723b36544a",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDDghiBesEq9QCm\nO6gmAdXdmdeMxFUpvHcxk1gZ93Z+kuJGw7USF6JAAoTiy2vWxK5gH6Loz0qjWemV\nH9v2v/qK+rcreb3W/R+uCq38zdWmTDjneYVBWV8+b5lYWXyJnB1K4O5ZksnsvBXV\n6JP8G5TVqn8j2DYKK4gJxW7Ff4nmrHfygJf3oB+1S0cYBAewV62fMbLuE8m1Qzpo\nprTkaDopYAJkUi+kIHoNDP5HfoRptk4xPboxGYBd2IITE1hQ6C5LNFuuHMAGTBy0\nS5y/hfiIj6ILoIlVOx8swebeVSHO3WwGBXu3DGs2NwDDiUmzQ63P8Z9IoUxMCq/n\ns01a417lAgMBAAECggEAJ1Px+IfYODsxLn9VJ5IacpmaD9XFuN/RzU3xvMV4F2WW\nMXx4XeOVrpEjKJkZgAov9qOeinz6a2owj+ApCBWdwVvGQW9bphXki8bXsYE5X1q5\nXqzmBpuDCoT6AJj9sZPPG6ssHyYlSuMZ9F30+NOWiLWjnjMFyd1wX+DQk9eARr+k\nXiuhze6+dPHntDkmFm79ujHp7xBIbbgBcChBqUBnarzJAZFazfJ8KrWMhBi7n2H9\npHjJHrqQQL4UHnBK7YlYTR6vfNUdLj8NkZENdeF4bQPkZk/XYeUb+Fqjrh1PqCXg\n1KG7GQ8xQlcxk44B8XhU/ahff8noJaMpBnZqRzepiQKBgQDhCP0awev+9K8YgCTm\nQQkHwmbRbU+CWHroPNDxgu01R8x4iNoTR4S2tDrzS1uZZM/G+KIKKvknLnEFoj9w\nB84fei+Y9D9Dl0geD/Chpm6JVCfHY07slPylmsT6UmQEjKR9pWdUKEQaY5Mnuh4b\n3g5bzLmXD0DNS4c8Rjjczq4ejQKBgQDeaQBgFePj3JwIkbWFL7qwk/Ig0BeeXMxg\nXPDZzeItUBBqJ4tO/CfU+apNouh1gV8UCSLPXEI+bh1uYZ/uZ91/1BUGxzGuD4Az\nFF5+viLha5PQiVTvGIBsSeY0H5sTM13ScFEHd78UsohGaDkw19lFrpXsOqaS+50x\nVVbUvDs3uQKBgQCP2TQZ955I0tZengN4YFhKan1ZIDv0AWVHsSCLUXsaVPQilLB6\nJHx0Yg9Q2HoMOwIKmYLTZxbvceNzi3xru8GKI4vrhS4vobPK67uRSZddF7t53ERm\nPPKnVaDWtvYSZmj7nFDJ3hdymvZFLdbzT2X0TpDQPELbOI2Q/P56P2/UPQKBgQCN\n+UMnEvItY4crJTBVe7lVvKtEbPGWwrAoF0wcDQQDXueLjACug+I9Xr5q3sI7OEFk\nPcy9x6v1xD7/VkxMWHsZfV2KvR8meHiioq8Lgv4rHYv3A6N3GRHpjmboAQDyCckr\na00eUj9ky+6X2zIezrrAc4j6ihoJG5slgc9y71Fx6QKBgQDeVRymJ1pKeUPWJkBZ\nt1lFVAPX1PNogyKr9529a3hCgfyGzoE5A8yba57J9uFUx897lIpABDuWA63o/BDb\nmfZZMKFultyrsbzxmHDilb4TIk52UyDQYVfvAvEwXgBApFTvCnLvKBLvppmx2tx+\nOanO5cKCvgR0LT6VwJBrHH3vkA==\n-----END PRIVATE KEY-----\n",
  "client_email": "firebase-adminsdk-esd11@prn-project-75959.iam.gserviceaccount.com",
  "client_id": "116975163824662417047",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-esd11%40prn-project-75959.iam.gserviceaccount.com",
  "universe_domain": "googleapis.com"
}" > google-credentials.json
          cat google-credentials.json


      - name: Verify Google Cloud credentials file
        run: |
          if [ ! -f google-credentials.json ]; then
            echo "google-credentials.json file is missing!"
            exit 1
          else
            echo "google-credentials.json file is present."
            cat google-credentials.json
          fi
        

      # - name: Set up environment variable for Firebase
      #   run: echo "GOOGLE_APPLICATION_CREDENTIALS_JSON=${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}" >> $GITHUB_ENV

      # - name: Build and push web image
      #   uses: docker/build-push-action@v2
      #   with:
      #     context: .
      #     file: ./docker/web/Dockerfile
      #     push: true
      #     tags: markvovn/dentistry-be-web:latest

      - name: Build and push migration image
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./docker/migration/Dockerfile
          push: true
          tags: markvovn/dentistry-be-migration:latest

          secrets: |
            id=google_application_credentials,src=/tmp/google-credentials.json


  update_server:
      name: Updating prod environment
      runs-on: ubuntu-latest
      needs: build
      steps:
        - name: Replacing container
          uses: appleboy/ssh-action@master
          with:
            host: ${{ secrets.SERVER_HOSTNAME }}
            username: ${{ secrets.SERVER_USERNAME }}
            password: ${{ secrets.SERVER_PASSWORD }}
            script: |
              cd dentistry
              docker compose pull
              docker compose up -d
